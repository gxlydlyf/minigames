<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>方块坦克大战</title><style>*{margin:0;padding:0}.left{float:left}.right{float:right}.clear-fixed:after{content:"";display:table;clear:both}.container{width:400px;height:650px;position:absolute;top:20px;left:50%;margin-left:-200px}.container .header{width:100%;height:50px;font-size:25px}.container .header .score-panel{font-size:20px}.container .header .score-panel,.container .header .title{height:50px;text-align:center;line-height:50px}#game-over{display:none;position:absolute;left:50%;top:50px;width:400px;height:600px;border-radius:10px;background-color:rgba(0,0,0,.6);margin-left:-200px;text-align:center;z-index:5}#game-over .panel{position:absolute;left:50%;right:50%;top:200px;width:220px;height:200px;border-radius:10px;background-color:#fff;margin-left:-110px;text-align:center;z-index:6}#again{display:inline-block;width:170px;height:50px;border-radius:10px;text-decoration:none;background-color:#9f8d77;color:#fff;font-size:36px}</style></head><body><div class=container><div class="header clear-fixed"><div class="title left">方块坦克大战</div><div class="score-panel left"><span> LV: </span><span id=level>1</span></div><div class="score-panel right"><span>得分: </span><span id=score>0</span></div></div><canvas id=canvas width=400 height=600></canvas><div id=game-over><div class=panel><h1 id=state style=margin-top:5px></h1><a href=javascript:; id=again>再试一次</a></div></div><div>TIP: 通过键盘 ↑ ↓ ← → 键操作转向和移动，按space键发射炮弹</div></div><script>var ROWS=30,COLS=20,BLOCK_SIZE=20,blockAlive=[[[0,1,0],[1,1,1],[1,0,1]],[[1,1,0],[0,1,1],[1,1,0]],[[1,0,1],[1,1,1],[0,1,0]],[[0,1,1],[1,1,0],[0,1,1]]],blockDead=[[[1,0,1],[0,1,0],[1,0,1]]],blockBullet=[[[1]]];</script><script>function deepCopyMatrix(r){var e=[];return r.map((function(r){r instanceof Array?e.push(deepCopyMatrix(r)):e.push(r)})),e}function mergeMatrix(r,e,t){var n=r.row,o=r.col,a=r.arr;t=t||!1;for(var u=deepCopyMatrix(e),i=0;i<a.length;i++)if(u[n+i]&&u[n+i]instanceof Array)for(var c=0;c<4;c++){var f=u[n+i][o+c],p=a[i][c];(t||o+c>=0&&p)&&(u[n+i][o+c]=1===f?1:p)}return u}function generatorMatrix(){for(var r=[],e=0;e<ROWS;e++){for(var t=[],n=0;n<COLS;n++)t.push(0);r.push(t)}return r}function $(r){return/^#\S+/.test(r)?document.querySelector(r):document.querySelectorAll(r)}</script><script>!function(i){var t=function(i){this.x=COLS/2-1,this.y=ROWS-3,this.roates=i||blockAlive,this.dir=0,this.data=this.roates[this.dir]};t.prototype={frame:0,rotate:function(){this.data=this.roates[this.dir]},isContactBorder:function(i){var t=this.dir;if([1,3].indexOf(t)>-1)for(var r=0;r<i.length;r++)if(3===t){if(1===i[r][0])return!0}else if(1===t&&1===i[r][COLS-1])return!0;if([0,2].indexOf(t)>-1)for(var e=0;e<i[0].length;e++)if(0===t){if(1===i[0][e])return!0}else if(2===t&&1===i[ROWS-1][e])return!0;return!1},checkMatrix:function(i,t){var r=t.x,e=t.y;return 1===i[r][e]},Collision:function(i,t){var r=t.row,e=t.col,n=t.arr,o=this.dir,s={x:r,y:e};if(1===o||3===o){s.y=e+(1===o?3:-1);for(var a=0;a<n.length;a++)if(s.x=r+a,this.checkMatrix(i,s))return!0}if(0===o||2===o){s.x=r+(0===o?-1:3);for(a=0;a<n.length;a++)if(s.y=e+a,this.checkMatrix(i,s))return!0}return!1},move:function(i,t){var r={row:this.y,col:this.x,arr:this.data},e=mergeMatrix(r,generatorMatrix());this.isContactBorder(e)||this.Collision(t,r)||([0,2].indexOf(this.dir)>-1&&(this.y+=i),[1,3].indexOf(this.dir)>-1&&(this.x+=i))},onDead:function(){this.roates=blockDead,this.data=this.roates[0]}},i.Tank=t}(window);</script><script>!function(i){var t=function(i){this.owner=i,this.dir=i.dir,this.roates=blockBullet,this.data=this.roates[0],this.init()};t.prototype={init:function(){var i=this.dir;0===i?(this.x=this.owner.x+1,this.y=this.owner.y):1===i?(this.x=this.owner.x+2,this.y=this.owner.y+1):2===i?(this.x=this.owner.x+1,this.y=this.owner.y+2):3===i&&(this.x=this.owner.x,this.y=this.owner.y+1)},isContactBorder:function(){var i=this.dir;return 0===i&&0===this.y||(1===i&&this.x===COLS-1||(2===i&&this.y===ROWS-1||3===i&&0===this.x))},Collision:function(i){var t=this.dir;return 0===t&&(0===this.y||1===i[this.y-1][this.x])||(1===t&&(this.x===COLS-1||1===i[this.y][this.x+1])||(2===t&&(this.y===ROWS-1||1===i[this.y+1][this.x])||3===t&&(0===this.x||1===i[this.y][this.x-1])))},move:function(){var i=this.dir;0===i?this.y--:1===i?this.x++:2===i?this.y++:3===i&&this.x--}},i.Bullet=t}(window);</script><script>!function(e,t){var i=function(e){this.canvas=$(e||"#canvas"),this.ctx=this.canvas.getContext("2d"),this.rows=ROWS,this.cols=COLS,this.latticeSize=BLOCK_SIZE,this.canvas.width=BLOCK_SIZE*this.cols,this.canvas.height=BLOCK_SIZE*this.rows,this.addEvent(),this.init()};i.prototype={enemyList:[],enemyPos:[{x:0,y:0,dir:2},{x:COLS/2-1,y:0,dir:2},{x:COLS-3,y:0,dir:2},{x:0,y:ROWS/2-1,dir:1},{x:COLS-3,y:ROWS/2-1,dir:3},{x:0,y:ROWS-3,dir:0},{x:COLS/2-1,y:ROWS-3,dir:0},{x:COLS-3,y:ROWS-3,dir:0}],bulletList:[],init:function(){this.matrix=generatorMatrix(),this.timer=null,this.player=new Tank,this.score=0,this.level=1,this.isOver=!1,this.enemyList=[],this.bulletList=[],this.step=60,$("#score").innerText=this.score,$("#level").innerText=this.level},addEvent:function(){var e=this;t.addEventListener("keydown",(function(t){if(e.isOver)return!1;var i=0,r=0;37===t.keyCode&&(i=-1,r=3),39===t.keyCode&&(i=1,r=1),38===t.keyCode&&(i=-1,r=0),40===t.keyCode&&(i=1,r=2),[37,38,39,40].indexOf(t.keyCode)>-1&&(e.player.dir===r?e.player.move(i,e.mergeMatrix(e.matrix)):(e.player.dir=r,e.player.rotate())),e.draw()})),t.addEventListener("keyup",(function(t){if(e.isOver)return!1;if(32===t.keyCode){var i=new Bullet(e.player);e.bulletList.push(i)}}))},mergeMatrix:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=deepCopyMatrix(e);if(this.player){var i=this.player.x,r=this.player.y,s=this.player.data;t=mergeMatrix({row:r,col:i,arr:s},t)}function n(e){var i=e.x,r=e.y,s=e.data;t=mergeMatrix({row:r,col:i,arr:s},t)}return this.enemyList.length>0&&this.enemyList.map((function(e){n(e)})),this.bulletList.length>0&&this.bulletList.map((function(e){n(e)})),t})),draw:function(){var e=this.ctx,t=this.canvas,i=this.latticeSize;e.clearRect(0,0,t.width,t.height);for(var r=this.mergeMatrix(this.matrix),s=0;s<r.length;s++)for(var n=r[s],a=0;a<n.length;a++){var h=n[a];e.fillStyle=0===h?"#eee":"#2196f3",e.fillRect(i*a+1,s*i+1,i-2,i-2)}},start:function(){this.createEnemy(),this.draw(),this.timer=setInterval(this.runtime.bind(this),50)},runtime:function(){for(var e=0;e<this.bulletList.length;e++){var t=this.mergeMatrix(this.matrix),i=this.bulletList[e];if(i.Collision(t)){var r=i.x,s=i.y,n=i.dir,a=deepCopyMatrix(this.enemyList);a.push(this.player),a.push.apply(a,this.bulletList);for(var h=0;h<a.length;h++){var l=a[h];if(l instanceof Tank){var o=l;if(i.owner===o)continue;if([0,2].indexOf(n)>-1&&r>=o.x&&r<=o.x+2&&s>=o.y-1&&s<=o.y+3||[1,3].indexOf(n)>-1&&s>=o.y&&s<=o.y+2&&r>=o.x-1&&r<=o.x+3){if(o===this.player)this.player.onDead(),this.gameOver();else if(i.owner===this.player){this.enemyList.splice(this.enemyList.indexOf(o),1),this.score+=100;var y=Math.floor(this.score/500)+1;this.step-=10*(y-this.level),this.level=y,$("#score").innerText=this.score,$("#level").innerText=this.level}break}}else if(l instanceof Bullet){var c=l;if([0,2].indexOf(n)>-1&&r===c.x&&s>=c.y-1&&s<=c.y+1||[1,3].indexOf(n)>-1&&s===c.y&&r>=c.x-1&&r<=c.x+1){var d=this.bulletList.indexOf(c);d<e&&e--,this.bulletList.splice(d,1);break}}}this.bulletList.splice(e,1),e--}else i.move()}for(e=0;e<this.enemyList.length;e++)this.enemyAutoRun(this.enemyList[e]);this.draw(),this.step--,this.step<=0&&(this.step=0,this.createEnemy())},createEnemy:function(){var e,t=!1,i=this.mergeMatrix(this.matrix);e:for(var r=0;r<this.enemyPos.length;r++){t=!1;t:for(var s=(e=this.enemyPos[r]).y;s<e.y+3;s++)for(var n=e.x;n<e.x+3;n++)if(1===i[s][n]){t=!0;break t}if(!t){var a=new Tank;a.dir=e.dir,a.x=e.x,a.y=e.y,a.rotate(),this.enemyList.push(a),this.step=60-10*this.level;break e}}},enemyAutoRun:function(e){if(e.frame++,e.frame%20==0){switch(~~(4*Math.random())){case 0:break;case 1:var t=~~(4*Math.random());e.dir=t,e.rotate();break;case 2:var i=this.mergeMatrix(this.matrix);[0,3].indexOf(e.dir)>-1?e.move(-1,i):[1,2].indexOf(e.dir)>-1&&e.move(1,i);break;case 3:this.bulletList.push(new Bullet(e))}e.frame=0}},gameOver:function(){var e=this;e.isOver=!0,setTimeout((function(){clearInterval(e.timer),$("#state").innerHTML="游戏结束<br>得分:<br>"+e.score,$("#state").style.color="red",$("#game-over").style.display="block"}),500)}};var r=new i;r.start(),$("#again").addEventListener("click",(function(){$("#game-over").style.display="none",r.init(),r.start()})),e.Game=i}(window,document);</script></body></html>