<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>方块坦克大战</title><style>*{margin:0;padding:0}.left{float:left}.right{float:right}.clear-fixed:after{content:"";display:table;clear:both}.container{width:400px;height:650px;position:absolute;top:20px;left:50%;margin-left:-200px}.container .header{width:100%;height:50px;font-size:25px}.container .header .score-panel{font-size:20px}.container .header .score-panel,.container .header .title{height:50px;text-align:center;line-height:50px}#game-over{display:none;position:absolute;left:50%;top:50px;width:400px;height:600px;border-radius:10px;background-color:rgba(0,0,0,.6);margin-left:-200px;text-align:center;z-index:5}#game-over .panel{position:absolute;left:50%;right:50%;top:200px;width:220px;height:200px;border-radius:10px;background-color:#fff;margin-left:-110px;text-align:center;z-index:6}#again{display:inline-block;width:170px;height:50px;border-radius:10px;text-decoration:none;background-color:#9f8d77;color:#fff;font-size:36px}</style></head><body><div class=container><div class="header clear-fixed"><div class="title left">方块坦克大战</div><div class="score-panel left"><span>&emsp;LV: </span><span id=level>1</span></div><div class="score-panel right"><span>得分: </span><span id=score>0</span></div></div><canvas id=canvas width=400 height=600></canvas><div id=game-over><div class=panel><h1 id=state style=margin-top:5px></h1><a href=javascript:; id=again>再试一次</a></div></div><div>TIP: 通过键盘 ↑ ↓ ← → 键操作转向和移动，按space键发射炮弹</div></div></body><script>let ROWS=30,COLS=20,BLOCK_SIZE=20,blockAlive=[[[0,1,0],[1,1,1],[1,0,1]],[[1,1,0],[0,1,1],[1,1,0]],[[1,0,1],[1,1,1],[0,1,0]],[[0,1,1],[1,1,0],[0,1,1]]],blockDead=[[[1,0,1],[0,1,0],[1,0,1]]],blockBullet=[[[1]]]</script><script>function deepCopyMatrix(r){var e=[];return r.map(function(r){r instanceof Array?e.push(deepCopyMatrix(r)):e.push(r)}),e}function mergeMatrix(r,e,t){for(var n=r.row,o=r.col,a=r.arr,u=(t=t||!1,deepCopyMatrix(e)),i=0;i<a.length;i++)if(u[n+i]&&u[n+i]instanceof Array)for(var c=0;c<4;c++){var f=u[n+i][o+c],p=a[i][c];(t||0<=o+c&&p)&&(u[n+i][o+c]=1===f?1:p)}return u}function generatorMatrix(){for(var r=[],e=0;e<ROWS;e++){for(var t=[],n=0;n<COLS;n++)t.push(0);r.push(t)}return r}function $(r){return/^#\S+/.test(r)?document.querySelector(r):document.querySelectorAll(r)}</script><script>(i=>{function t(i){this.x=COLS/2-1,this.y=ROWS-3,this.roates=i||blockAlive,this.dir=0,this.data=this.roates[this.dir]}t.prototype={frame:0,rotate:function(){this.data=this.roates[this.dir]},isContactBorder:function(i){var t=this.dir;if(-1<[1,3].indexOf(t))for(var r=0;r<i.length;r++)if(3===t){if(1===i[r][0])return!0}else if(1===t&&1===i[r][COLS-1])return!0;if(-1<[0,2].indexOf(t))for(var e=0;e<i[0].length;e++)if(0===t){if(1===i[0][e])return!0}else if(2===t&&1===i[ROWS-1][e])return!0;return!1},checkMatrix:function(i,{x:t,y:r}){return 1===i[t][r]},Collision:function(i,t){var r=t.row,e=t.col,n=t.arr,t=this.dir,o={x:r,y:e};if(1===t||3===t){o.y=e+(1===t?3:-1);for(var s=0;s<n.length;s++)if(o.x=r+s,this.checkMatrix(i,o))return!0}if(0===t||2===t){o.x=r+(0===t?-1:3);for(s=0;s<n.length;s++)if(o.y=e+s,this.checkMatrix(i,o))return!0}return!1},move:function(i,t){var r={row:this.y,col:this.x,arr:this.data},e=mergeMatrix(r,generatorMatrix());this.isContactBorder(e)||this.Collision(t,r)||(-1<[0,2].indexOf(this.dir)&&(this.y+=i),-1<[1,3].indexOf(this.dir)&&(this.x+=i))},onDead:function(){this.roates=blockDead,this.data=this.roates[0]}},i.Tank=t})(window)</script><script>(i=>{function t(i){this.owner=i,this.dir=i.dir,this.roates=blockBullet,this.data=this.roates[0],this.init()}t.prototype={init:function(){var i=this.dir;0===i?(this.x=this.owner.x+1,this.y=this.owner.y):1===i?(this.x=this.owner.x+2,this.y=this.owner.y+1):2===i?(this.x=this.owner.x+1,this.y=this.owner.y+2):3===i&&(this.x=this.owner.x,this.y=this.owner.y+1)},isContactBorder:function(){var i=this.dir;return 0===i&&0===this.y||1===i&&this.x===COLS-1||2===i&&this.y===ROWS-1||3===i&&0===this.x},Collision:function(i){var t=this.dir;return 0===t&&(0===this.y||1===i[this.y-1][this.x])||1===t&&(this.x===COLS-1||1===i[this.y][this.x+1])||2===t&&(this.y===ROWS-1||1===i[this.y+1][this.x])||3===t&&(0===this.x||1===i[this.y][this.x-1])},move:function(){var i=this.dir;0===i?this.y--:1===i?this.x++:2===i?this.y++:3===i&&this.x--}},i.Bullet=t})(window)</script><script>((e,t)=>{function i(e){this.canvas=$(e||"#canvas"),this.ctx=this.canvas.getContext("2d"),this.rows=ROWS,this.cols=COLS,this.latticeSize=BLOCK_SIZE,this.canvas.width=BLOCK_SIZE*this.cols,this.canvas.height=BLOCK_SIZE*this.rows,this.addEvent(),this.init()}i.prototype={enemyList:[],enemyPos:[{x:0,y:0,dir:2},{x:COLS/2-1,y:0,dir:2},{x:COLS-3,y:0,dir:2},{x:0,y:ROWS/2-1,dir:1},{x:COLS-3,y:ROWS/2-1,dir:3},{x:0,y:ROWS-3,dir:0},{x:COLS/2-1,y:ROWS-3,dir:0},{x:COLS-3,y:ROWS-3,dir:0}],bulletList:[],init:function(){this.matrix=generatorMatrix(),this.timer=null,this.player=new Tank,this.score=0,this.level=1,this.isOver=!1,this.enemyList=[],this.bulletList=[],this.step=60,$("#score").innerText=this.score,$("#level").innerText=this.level},addEvent:function(){var s=this;t.addEventListener("keydown",function(e){if(s.isOver)return!1;var t=0,i=0;37===e.keyCode&&(t=-1,i=3),39===e.keyCode&&(i=t=1),38===e.keyCode&&(t=-1,i=0),40===e.keyCode&&(t=1,i=2),-1<[37,38,39,40].indexOf(e.keyCode)&&(s.player.dir===i?s.player.move(t,s.mergeMatrix(s.matrix)):(s.player.dir=i,s.player.rotate())),s.draw()}),t.addEventListener("keyup",function(e){if(s.isOver)return!1;32===e.keyCode&&(e=new Bullet(s.player),s.bulletList.push(e))})},mergeMatrix:function(e){var t,i,s=deepCopyMatrix(e);function r(e){var t=e.x;s=mergeMatrix({row:e.y,col:t,arr:e.data},s)}return this.player&&(e=this.player.x,t=this.player.y,i=this.player.data,s=mergeMatrix({row:t,col:e,arr:i},s)),0<this.enemyList.length&&this.enemyList.map(function(e){r(e)}),0<this.bulletList.length&&this.bulletList.map(function(e){r(e)}),s},draw:function(){for(var e=this.ctx,t=this.canvas,i=this.latticeSize,s=(e.clearRect(0,0,t.width,t.height),this.mergeMatrix(this.matrix)),r=0;r<s.length;r++)for(var a=s[r],n=0;n<a.length;n++){var h=a[n];e.fillStyle=0===h?"#eee":"#2196f3",e.fillRect(i*n+1,r*i+1,i-2,i-2)}},start:function(){this.createEnemy(),this.draw(),this.timer=setInterval(this.runtime.bind(this),50)},runtime:function(){for(var e=0;e<this.bulletList.length;e++){var t=this.mergeMatrix(this.matrix),i=this.bulletList[e];if(i.Collision(t)){var s=i.x,r=i.y,a=i.dir,n=deepCopyMatrix(this.enemyList);n.push(this.player),n.push.apply(n,this.bulletList);for(var h=0;h<n.length;h++){var l=n[h];if(l instanceof Tank){var o=l;if(i.owner!==o&&(-1<[0,2].indexOf(a)&&s>=o.x&&s<=o.x+2&&r>=o.y-1&&r<=o.y+3||-1<[1,3].indexOf(a)&&r>=o.y&&r<=o.y+2&&s>=o.x-1&&s<=o.x+3)){o===this.player?(this.player.onDead(),this.gameOver()):i.owner===this.player&&(this.enemyList.splice(this.enemyList.indexOf(o),1),this.score+=100,o=Math.floor(this.score/500)+1,this.step-=10*(o-this.level),this.level=o,$("#score").innerText=this.score,$("#level").innerText=this.level);break}}else if(l instanceof Bullet){o=l;if(-1<[0,2].indexOf(a)&&s===o.x&&r>=o.y-1&&r<=o.y+1||-1<[1,3].indexOf(a)&&r===o.y&&s>=o.x-1&&s<=o.x+1){l=this.bulletList.indexOf(o);l<e&&e--,this.bulletList.splice(l,1);break}}}this.bulletList.splice(e,1),e--}else i.move()}for(e=0;e<this.enemyList.length;e++)this.enemyAutoRun(this.enemyList[e]);this.draw(),this.step--,this.step<=0&&(this.step=0,this.createEnemy())},createEnemy:function(){for(var e,t=!1,i=this.mergeMatrix(this.matrix),s=0;s<this.enemyPos.length;s++){t=!1;e:for(var r=(e=this.enemyPos[s]).y;r<e.y+3;r++)for(var a=e.x;a<e.x+3;a++)if(1===i[r][a]){t=!0;break e}if(!t){var n=new Tank;n.dir=e.dir,n.x=e.x,n.y=e.y,n.rotate(),this.enemyList.push(n),this.step=60-10*this.level;break}}},enemyAutoRun:function(e){if(e.frame++,e.frame%20==0){switch(~~(4*Math.random())){case 0:break;case 1:var t=~~(4*Math.random());e.dir=t,e.rotate();break;case 2:t=this.mergeMatrix(this.matrix);-1<[0,3].indexOf(e.dir)?e.move(-1,t):-1<[1,2].indexOf(e.dir)&&e.move(1,t);break;case 3:this.bulletList.push(new Bullet(e))}e.frame=0}},gameOver:function(){var e=this;e.isOver=!0,setTimeout(function(){clearInterval(e.timer),$("#state").innerHTML="游戏结束<br>得分:<br>"+e.score,$("#state").style.color="red",$("#game-over").style.display="block"},500)}};var s=new i;s.start(),$("#again").addEventListener("click",function(){$("#game-over").style.display="none",s.init(),s.start()}),e.Game=i})(window,document)</script></html>